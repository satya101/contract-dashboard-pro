// src/pages/Results.jsx
import React, { useEffect, useRef, useState } from "react";
import ResultsHeader from "../components/ResultsHeader.jsx";
import SummaryKeyCards from "../components/SummaryKeyCards.jsx";
import AuditSection from "../components/AuditSection.jsx";
import FeedbackPanel from "../components/FeedbackPanel.jsx";
import { exportSummaryAsPDF } from "../utils/pdfExport.js";
import { loadLastSummary } from "../services/storage.js";
import { shareEmail } from "../services/API.js";

const buildEmailHTML = (fileName, summary) => {
  const esc = (s) => (s ?? "").toString();
  return `
  <div style="font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;line-height:1.5;color:#111827">
    <h2 style="margin:0 0 8px 0">Section 32 Report</h2>
    <div style="color:#6b7280;margin-bottom:16px">${esc(fileName)}</div>

    <h3 style="margin:16px 0 8px 0">Contract Summary</h3>
    <table cellspacing="0" cellpadding="8" style="border-collapse:separate;border-spacing:0 8px;width:100%">
      <tr style="background:#f8fafc"><td style="width:33%">
        <strong>Property Details</strong><br/>
        Address: ${esc(summary.property?.address || summary.title?.address || "")}<br/>
        Lot/Plan: ${esc(summary.property?.lot_plan || summary.title?.lot_plan || "")}<br/>
        Land Size: ${esc(summary.property?.land_size || "")}<br/>
        Zoning: ${esc(summary.property?.zoning || summary.planning_zoning?.zoning || "")}
      </td><td style="width:33%">
        <strong>Financial Terms</strong><br/>
        Purchase Price: ${esc(summary.financial_terms?.purchase_price || summary.price || "")}<br/>
        Deposit: ${esc(summary.financial_terms?.deposit || "")}<br/>
        Balance: ${esc(summary.financial_terms?.balance || "")}<br/>
        Stamp Duty: ${esc(summary.financial_terms?.stamp_duty || "")}
      </td><td style="width:33%">
        <strong>Key Dates</strong><br/>
        Settlement: ${esc(summary.key_dates?.settlement || "")}<br/>
        Finance Due: ${esc(summary.key_dates?.finance_due || "")}<br/>
        Cooling Off: ${esc(summary.key_dates?.cooling_off || "")}<br/>
        Possession: ${esc(summary.key_dates?.possession || "")}
      </td></tr>
    </table>

    <p style="color:#6b7280;margin-top:16px">
      Generated by S32 Insights Portal.
    </p>
  </div>`;
};

export default function Results() {
  const [fileName, setFileName] = useState("");
  const [summary, setSummary] = useState(null);
  const summaryRef = useRef(null);

  useEffect(() => {
    const last = loadLastSummary();
    setFileName(last?.fileName || "");
    setSummary(last?.summary || null);
  }, []);

  const onExportPDF = async () => {
    if (!summaryRef.current) return;
    await exportSummaryAsPDF({
      container: summaryRef.current,
      docTitle: fileName || "S32 Insights Report",
    });
  };

  const onShareEmail = async ({ to }) => {
    if (!summary) return;
    const subject = `S32 Insights Report — ${fileName || "Contract"}`;
    const html = buildEmailHTML(fileName, summary);
    const text = html.replace(/<[^>]+>/g, "");
    const resp = await shareEmail({ to, subject, html, text }).catch(() => null);

    if (!resp?.sent) {
      // Fallback to mailto (plain text)
      window.location.href = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(text)}`;
    }
  };

  if (!summary) {
    return (
      <div className="bg-white border rounded-2xl p-10 text-center shadow-sm">
        No result loaded. Please upload a contract on <a className="text-blue-600 underline" href="/dashboard">AI Analysis</a>.
      </div>
    );
  }

  return (
    <div>
      <ResultsHeader
        fileName={fileName}
        processedAt={Date.now()}
        processingSeconds={4.2}
        pages={undefined}
        onExportPDF={onExportPDF}      // “Download Report” button calls this
        onShareEmail={onShareEmail}    // “Share Report” button calls this
      />

      {/* Everything inside this container is exported to PDF */}
      <div ref={summaryRef} className="space-y-4 mt-3">
        <SummaryKeyCards summary={summary} />
        <AuditSection summary={summary} />
        <FeedbackPanel onSubmit={() => {}} />
      </div>
    </div>
  );
}